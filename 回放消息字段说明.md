# YouTube 聊天回放消息字段说明

## 代码实现逻辑中保留的回放消息字段

在 `parse_messages()` 函数中（第 81-125 行），从 YouTube API 响应中提取并保留以下字段：

### 保留的核心字段

1. **time_text** (时间戳文本)
   - 数据类型: `str`
   - 格式: `"M:SS"` 或 `"H:MM:SS"`
   - 来源: 
     - 优先从 `videoOffsetTimeMsec` 转换而来（毫秒转为时间戳）
     - 备选从 `timestampText.simpleText` 直接获取
   - 示例: `"0:15"`, `"1:30:45"`
   - 说明: 消息在视频中的时间位置

2. **author** (作者/用户名)
   - 数据类型: `str`
   - 来源: `authorName.simpleText`
   - 处理: 自动去除首尾空格（`.strip()`）
   - 说明: 发送聊天消息的用户名称
   - 验证: 如果为空则跳过该消息

3. **msg** (消息内容)
   - 数据类型: `str`
   - 来源: `message.runs[]` 数组中所有 `text` 字段的拼接
   - 处理: 
     - 拼接所有 runs 中的文本片段
     - 去除首尾空格
     - 删除非法字符（`\x00-\x1F` 和 `\x7F`）
   - 说明: 聊天消息的实际文本内容
   - 验证: 如果为空则跳过该消息

4. **offset** (偏移时间毫秒)
   - 数据类型: `int`
   - 单位: 毫秒 (milliseconds)
   - 来源: `videoOffsetTimeMsec`
   - 默认值: `0`
   - 说明: 消息相对于视频开始的精确时间偏移
   - 用途: 用于排序和时长计算

### 支持的消息类型

代码遍历以下两种消息渲染器类型：

1. **liveChatTextMessageRenderer**
   - 普通文本消息
   - 标准聊天内容

2. **liveChatPaidMessageRenderer**
   - 付费消息（Super Chat / 超级留言）
   - 包含付费支持的消息

### JSON 数据结构路径

完整的数据提取路径：
```
actions[]
  └─ replayChatItemAction
      └─ actions[0]
          └─ addChatItemAction
              └─ item
                  └─ liveChatTextMessageRenderer / liveChatPaidMessageRenderer
                      ├─ authorName.simpleText          → author
                      ├─ message.runs[].text            → msg
                      ├─ videoOffsetTimeMsec            → offset, time_text
                      └─ timestampText.simpleText       → time_text (备选)
```

### 过滤规则

以下消息会被跳过，不会保留：

1. **空作者**: `author` 为空或仅包含空格
2. **空消息**: `msg` 为空或仅包含空格
3. **负时间戳**: 
   - `videoOffsetTimeMsec < 0`
   - `timestampText.simpleText` 以 `"-"` 开头

### 输出格式

这些字段最终按以下格式输出到 CSV 文件：

```csv
time,user,comment
0:15,用户名A,消息内容A
0:30,用户名B,消息内容B
1:00:00,用户名C,消息内容C
```

输出使用前三个字段（time_text, author, msg），而 offset 字段用于内部逻辑处理。

### 返回值

函数返回一个元组：
- `messages`: 包含所有有效消息的列表，每个消息是 `(time_text, author, msg, offset)` 元组
- `latest_offset`: 当前批次中最大的 offset 值（用于跟踪进度）
