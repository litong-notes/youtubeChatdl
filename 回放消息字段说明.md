# YouTube 聊天回放消息字段说明

## 代码实现逻辑中保留的回放消息字段

在 `parse_messages()` 函数中（第 107-149 行），从 YouTube API 响应中提取并保留以下字段，并存储到 SQLite 数据库中。

### 保留的核心字段（存储到数据库）

1. **time_text** (时间戳文本)
   - 数据类型: `str`
   - 格式: `"M:SS"` 或 `"H:MM:SS"`
   - 来源: 
     - 优先从 `videoOffsetTimeMsec` 转换而来（毫秒转为时间戳）
     - 备选从 `timestampText.simpleText` 直接获取
   - 示例: `"0:15"`, `"1:30:45"`
   - 说明: 消息在视频中的时间位置

2. **author** (作者/用户名)
   - 数据类型: `str`
   - 来源: `authorName.simpleText`
   - 处理: 自动去除首尾空格（`.strip()`）
   - 说明: 发送聊天消息的用户名称
   - 验证: 如果为空则跳过该消息

3. **author_id** (作者频道ID)
   - 数据类型: `str`
   - 来源: `authorExternalChannelId`
   - 格式: 通常以 `UC` 开头的 YouTube 频道 ID
   - 说明: 发送消息用户的 YouTube 频道唯一标识符
   - 用途: 用于唯一标识用户，跨视频追踪同一用户
   - 示例: `"UCxxxxxxxxxxxxxxxxxxxxx"`

4. **message** (消息内容)
   - 数据类型: `str`
   - 来源: `message.runs[]` 数组中所有 `text` 字段的拼接
   - 处理: 
     - 拼接所有 runs 中的文本片段
     - 去除首尾空格
     - 删除非法字符（`\x00-\x1F` 和 `\x7F`）
   - 说明: 聊天消息的实际文本内容
   - 验证: 如果为空则跳过该消息

5. **offset_ms** (偏移时间毫秒)
   - 数据类型: `int`
   - 单位: 毫秒 (milliseconds)
   - 来源: `videoOffsetTimeMsec`
   - 默认值: `0`
   - 说明: 消息相对于视频开始的精确时间偏移
   - 用途: 用于排序和时长计算
   - 注意: 可以为负数（直播开始前的等待消息）

### 支持的消息类型

代码遍历以下两种消息渲染器类型：

1. **liveChatTextMessageRenderer**
   - 普通文本消息
   - 标准聊天内容

2. **liveChatPaidMessageRenderer**
   - 付费消息（Super Chat / 超级留言）
   - 包含付费支持的消息

### JSON 数据结构路径

完整的数据提取路径：
```
actions[]
  └─ replayChatItemAction
      └─ actions[0]
          └─ addChatItemAction
              └─ item
                  └─ liveChatTextMessageRenderer / liveChatPaidMessageRenderer
                      ├─ authorName.simpleText          → author
                      ├─ authorExternalChannelId        → author_id
                      ├─ message.runs[].text            → message
                      ├─ videoOffsetTimeMsec            → offset_ms, time_text
                      └─ timestampText.simpleText       → time_text (备选)
```

### 过滤规则

以下消息会被跳过，不会保留：

1. **空作者**: `author` 为空或仅包含空格
2. **空消息**: `message` 为空或仅包含空格

**注意**：负时间戳的消息不再被过滤，会完整保留到数据库中。

### 数据库存储格式

这些字段存储到 SQLite 数据库表 `chat_messages` 中：

```sql
CREATE TABLE chat_messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    time_text TEXT,
    author TEXT,
    author_id TEXT,
    message TEXT,
    offset_ms INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 数据库查询示例

```sql
-- 按时间顺序查看所有消息
SELECT time_text, author, message FROM chat_messages ORDER BY offset_ms;

-- 查看特定用户的所有消息
SELECT time_text, message FROM chat_messages 
WHERE author_id = 'UCxxxxxxxxxxxxxxxxxxxxx' 
ORDER BY offset_ms;

-- 统计每个用户的消息数量
SELECT author, author_id, COUNT(*) as count 
FROM chat_messages 
GROUP BY author_id 
ORDER BY count DESC;

-- 查看负时间戳消息（直播前的等待消息）
SELECT time_text, author, message FROM chat_messages 
WHERE offset_ms < 0 
ORDER BY offset_ms;
```

### 返回值

函数返回一个元组：
- `messages`: 包含所有有效消息的列表，每个消息是 `(time_text, author, author_id, message, offset_ms)` 元组
- `latest_offset`: 当前批次中最大的 offset 值（用于跟踪进度）

### 数据库索引

为优化查询性能，创建了以下索引：
- `idx_offset`: 在 `offset_ms` 字段上的索引，用于按时间排序
- `idx_author_id`: 在 `author_id` 字段上的索引，用于按用户查询
